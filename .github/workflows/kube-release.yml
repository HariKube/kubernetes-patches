name: Kube Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Kubernetes version'
        required: true
        type: string

concurrency: 
  group: ${{ github.ref_name }}-release
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  release-kubernetes:
    strategy:
      matrix:
        what:
        - cmd/kube-apiserver
        - cmd/kube-controller-manager
        arch:
        - linux/amd64
        - linux/ppc64le
        - linux/s390x
        - linux/arm64
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - uses: actions/checkout@v4
    - uses: actions/checkout@v4
      with:
        repository: kubernetes/kubernetes
        ref: ${{ inputs.version }}
        path: kubernetes
        token: ${{ secrets.GIT_HUB_TOKEN }}
        github-server-url: https://github.com
    - name: Login to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ vars.REGISTRY }}
        username: ${{ vars.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_TOKEN }}
    - name: Build Kubernetes images
      run: |
        (cd kubernetes ; git apply ${{ github.workspace }}/kubernetes-${{ inputs.version }}.patch)
        sed -i 's/WHAT="${CMD_TARGETS}"/WHAT="${WHAT}"' ${{ github.workspace }}/kubernetes/build/release-images.sh
        sed -i 's/KUBE_BUILD_PLATFORMS="${KUBE_SERVER_PLATFORMS[*]}"/KUBE_BUILD_PLATFORMS="${ARCH}"' ${{ github.workspace }}/kubernetes/build/release-images.sh
        make -C kubernetes release-images
      env:
        KUBE_FASTBUILD: "false"
        KUBE_GIT_TREE_STATE: clean
        KUBE_GIT_VERSION: ${{ inputs.version }}
        KUBE_RELEASE_RUN_TESTS: n
        KUBE_DOCKER_REGISTRY: ${{ vars.REGISTRY }}/${{ vars.REPOSITORY }}
        WHAT: ${{ matrix.what }}
        ARCH: ${{ matrix.arch }}
    - name: Push images
      run: |
        docker push ${{ vars.REGISTRY }}/${{ vars.REPOSITORY }}/kube-apiserver-${{ matrix.arch }}:${{ inputs.version }}
        docker push ${{ vars.REGISTRY }}/${{ vars.REPOSITORY }}/kube-controller-manager-${{ matrix.arch }}:${{ inputs.version }}
